pkgbase='busybox'
pkgname=('busybox-doc' 'busybox')
pkgver=1.28.0.r183.g23286900d
pkgrel=1
pkgdesc='Size optimized toolbox of many common UNIX utilities'
url='https://busybox.net/'
arch=('x86_64')
license=('GPL2')
depends_doc=()
depends=('musl')
makedepends=('linux-headers')
source=('git://busybox.net/busybox.git'
        'config'
        'clang.patch')
sha256sums=('SKIP'
            '06c55a0599956b3359805477ad569830fb867374847a711a219ab456c45cb60a'
            'e5728d8291834c5ea2f71efc5befb4a3c3987c1a6920065afc701959d432e901')

pkgver() {
  cd "${pkgbase}"
  
  git describe --long --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/[_-]/./g'
}

prepare() {
  cd "${pkgbase}"
  
  patch -Np0 < "${srcdir}/clang.patch"
  
  cp -f "${srcdir}/config" .config
  
  #set install directory
  sed -i -e "s|CONFIG_PREFIX=.*|CONFIG_PREFIX=\"${tmpdir}\"|" .config
  
  yes "" | make oldconfig
}

build() {
  cd "$pkgbase"
  
  CFLAGS=${CFLAGS//'-flto=thin'/}
  CXXFLAGS=${CXXFLAGS//'-flto=thin'/}
  LDFLAGS=${LDFLAGS//'-flto=thin'/}
  
  make
}

package() {
  package-init
  
  cd "${pkgbase}"
  
  CFLAGS=${CFLAGS//'-flto=thin'/}
  CXXFLAGS=${CXXFLAGS//'-flto=thin'/}
  LDFLAGS=${LDFLAGS//'-flto=thin'/}
  
  make install
  
  install -d "${tmpdir}/var/lib/udhcpd"
  install -Dm644 "examples/udhcp/udhcpd.conf" "${tmpdir}/etc/udhcpd.conf"
  install -Dm755 "examples/udhcp/simple.script" "${tmpdir}/usr/share/udhcpc/default.script"
  
  install -Dm644 "docs/busybox.1" "${tmpdir}/usr/share/man/man1"
}

package_busybox-doc() {
  package-doc
}

package_busybox() {
  groups=('base')
  
  package-base
}
